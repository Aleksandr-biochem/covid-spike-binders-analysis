# 4. MM-GBSA binding free energy estimation

Requirements:
- `Amber20` (build with MPI)
- `slurm` (20.11.8)
- [pyxmolpp2](https://github.com/sizmailov/pyxmolpp2) (1.6.0)
- [md-utils](https://github.com/OOLebedenko/md-utils)

Within this step MM-GBSA decomposition calculations are performed to investigate contributions of distinct residue pairs in MP3/RBD binding. 

- MM-GBSA_decomposition jobs are prepared at the MD folders (at `2_MD_Amber`) and saved as `state.dill` objects at `8_mmpbsa_decomp` subdirs
- Two models are used in scripts: igb2 and igb8. To our experience, their results are quite consistent, so employng igb8 could be sufficient. However, a comparison of two models can be helpful. **Note:** if you want to relate decomposition results to MM-GBSA results, make sure to compare same igb models.
- Salt concentration is set to 0.15M
- `script150_igb2_decomp.in` and `script150_igb8_decomp.in` are template scripts containing parameters for MM-GBSA runs. These are modifyed with `decomp` parameters during the job preparation and can be modifyed with additional parameters if neccessary
- By default 1000 frames from trajectory are used with 1 ns stride starting from 500 ns of simulation. This span corresponds to an equilibrated complex configuration

0. A list of interface residues is required to run decomposition. This list is found using `analyze_interface_residues.py`. **Note:** this script operates on `7_mmpbsa/mmpbsa.nc` trajectory assembled in step №4 for MM-GBSA. If you want to skip MM-GBSA calculations, at least execute `prep_MMPBSA_jobs.py` to create these .nc files.
The script will create `interface_residues` dir, write .txt files with interface residues and their trajectory occurancies in % and print spans of interface residues ids for decomposition .in scripts:
```sh
python analyze_interface_residues.py
```
1.  Execute `prep_MMPBSA_decomp_jobs.py` after scpecifying the list of complexes for analysis in `mutants` variable. The list of interface residues to be analyzed is already provided inside the script as `roi` variable. Note that this script assumes working with MPI, therefore mpi-amber assembly is needed:
```sh
python prep_MMPBSA_decomp_jobs.py
```
2. Run jobs (don't forget to specify `mutants`, and specify paths to amber and python env inside the script):
```sh
sbatch run_slurm_decomposition.sh
```
3. Amber produces summary in .dat format, however for a detailed analysis `_MMPBSA_info` should be parsed using Amber's API. Execute `analyze_mmgbsa_decomp.py` after specifying `mutants` for analysis. The script looks for interactions with total energy above 1 or below -1. Precomputed tables for MP3 are available in `tables`.
Note that processing can take a while, because `_MMPBSA_info` parsing is time-consuming. However, after first script run the parsed data is dumped into pickle, so the next parsing will be more rapid. By default, frames are analyzed starting from 500th. It can be changed in `first_frame` variable inside the script.
```sh
python analyze_mmgbsa_decomp.py
```
4. In order to plot decomposition results as differential contact maps use `plot_decomp_result.py` providing the path to data folder and igb model to summarize:
```sh
python plot_decomp_result.py -h # to get help
python plot_decomp_result.py -i ../tables -igb igb2
```
**Note:** in order to plot same residue spans at contact maps, the script analyses tables for all complexes generated by `analyze_mmgbsa_decomp.py`. If you add new complex type to the analysis, modify `mutants` variable inside the script.

**Obtained results:**
MM-GBSA decomposition allows a detailed analysis of residue interactions. Results are plotted as differential contact maps providing ineraction energy difference from respective residue pairs in MP3/wt RDB complex. 

For example, the contact map for the complex with omicron highlights a strong interaction between Asp37 in MP3 and Arg493 in RBD, which leads to overall decrease in ΔG binding.

<p align="center">
  <img src="results_plots/contact_map_omicron+mp3_igb8.png" width="700">
</p>

Comparison of contact maps for delta+ with MP3/MP3(D37R)/MP3(T10W;D37R) shows, that while destabilizations present in complex with MP3 persist in other complexes, D37R mutation provides a stabilizing interaction of Arg37 with Glu484 in RDB. Addition of T10W mutation provides no significant local or nonlocal stabilizations.

<p align="center">
  <img src="results_plots/contact_map_delta_plus+mp3_igb8.png" width="700">
</p>

<p align="center">
  <img src="results_plots/contact_map_delta_p+mp3_d37r_igb8.png" width="700">
</p>

<p align="center">
  <img src="results_plots/contact_map_delta_p+mp3_d37r_t10w_igb8.png" width="700">
</p>
